<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Sub-Zero MK2 | Marketplace</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* --- GLOBAL FIXES --- */
        * { box-sizing: border-box; } 

        .online-indicator { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 15px; font-family: 'Inter', sans-serif; font-weight: bold; color: var(--sys-green); }
        .dot { width: 10px; height: 10px; background-color: var(--sys-green); border-radius: 50%; box-shadow: 0 0 10px var(--sys-green); animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(68, 255, 68, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(68, 255, 68, 0); } 100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(68, 255, 68, 0); } }
        
        .leader-text { font-family: 'Inter', sans-serif; font-weight: 900; color: #ff0000; text-transform: uppercase; letter-spacing: 2px; animation: leader-pulse 1.5s infinite alternate; text-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
        @keyframes leader-pulse { from { text-shadow: 0 0 5px #ff0000; opacity: 0.8; } to { text-shadow: 0 0 15px #ff0000, 0 0 5px white; opacity: 1; transform: scale(1.05); } }

        /* --- CHAT CONTAINER --- */
        #chat {
            display: flex;
            flex-direction: column;
            align-items: center; 
            width: 100%;
            padding: 10px;
            padding-bottom: 100px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        /* --- MESSAGES --- */
        .msg {
            max-width: 88%;
            width: auto;
            word-wrap: break-word;
            margin-bottom: 10px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            color: #eee;
            position: relative;
            flex-shrink: 0;
        }
        .msg.me { align-self: flex-end; background: rgba(0, 100, 255, 0.1); }
        .msg:not(.me) { align-self: flex-start; }

        /* --- PROFILE PICTURE STYLES --- */
        .profile-pic-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover; /* Schneidet das Bild in den Kreis */
            border: 2px solid var(--ice);
            margin-bottom: 10px;
            cursor: pointer;
        }
        .profile-pic-large:hover { opacity: 0.8; }
        
        .header-icon {
            font-size: 28px;
            color: #fff;
            cursor: pointer;
            padding: 5px;
        }

        /* --- MARKETPLACE MODAL --- */
        #sell-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
        
        #open-sell-btn { 
            display: none; background: linear-gradient(135deg, var(--sys-yellow), #ffaa00); color: #000; 
            font-weight: 900; font-size: 24px; border: none; width: 45px; border-radius: 12px; margin-right: 8px; cursor: pointer; box-shadow: 0 0 15px rgba(255, 200, 0, 0.3); transition: 0.2s; 
        }
        #open-sell-btn:active { transform: scale(0.95); }

        .type-btn { flex: 1; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; border: 1px solid #333; background: #111; color: #666; transition: 0.3s; font-family: 'Inter', sans-serif; }
        .type-btn.active-wts { background: rgba(68, 255, 68, 0.1); color: var(--sys-green); border: 1px solid var(--sys-green); box-shadow: 0 0 15px rgba(68, 255, 68, 0.2); }
        .type-btn.active-wtb { background: rgba(255, 68, 68, 0.1); color: var(--sys-red); border: 1px solid var(--sys-red); box-shadow: 0 0 15px rgba(255, 68, 68, 0.2); }

        /* --- PRODUCT CARD STYLE --- */
        .product-card {
            background: #0d1117;
            border: 1px solid #21262d;
            border-radius: 16px;
            padding: 16px;
            margin: 15px 0;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 95%; 
            min-width: 280px; 
            flex-shrink: 0; 
            display: block; 
            clear: both;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card-tag { font-size: 10px; font-weight: 800; padding: 4px 8px; border-radius: 6px; position: absolute; top: 12px; left: 12px; text-transform: uppercase; letter-spacing: 1px; background: rgba(0,0,0,0.5); }

        .card-del-btn {
            position: absolute; top: 8px; right: 8px; 
            width: 32px; height: 32px;
            background: rgba(20, 20, 20, 0.9);
            color: #ff4444; border: 1px solid #333; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 100; 
            transition: 0.2s; font-weight: bold; font-size: 18px;
        }
        .card-del-btn:hover { background: #ff4444; color: white; transform: scale(1.1); }
        
        .del-x { float: right; margin-left: 10px; color: #ff4444; cursor: pointer; font-weight: bold; font-size: 14px; }

        .field-label { display: block; font-size: 9px; color: #666; text-transform: uppercase; letter-spacing: 1px; margin-top: 15px; font-weight: bold; }
        .card-title { font-size: 16px; font-weight: bold; color: #fff; display: block; margin-top: 2px; word-wrap: break-word; }
        .card-price-tag { font-family: 'Inter', monospace; font-size: 24px; font-weight: 900; letter-spacing: -1px; display: block; margin-top: 2px; }
        .card-desc { font-size: 13px; color: #aaa; margin-bottom: 15px; display: block; border-top: 1px solid #333; padding-top: 5px; line-height: 1.4; word-wrap: break-word; }
        
        .seller-info { display: flex; align-items: center; gap: 5px; margin-top: 35px; font-size: 11px; color: #888; }
        
        .buy-btn {
            width: 100%; padding: 12px; margin-top: 10px;
            background: rgba(255,255,255,0.05); border: 1px solid #333; 
            color: #fff; border-radius: 8px; font-weight: bold; cursor: pointer;
            transition: 0.2s; text-transform: uppercase; font-size: 12px; letter-spacing: 1px;
        }
        .buy-btn:hover { background: var(--ice); color: #000; border-color: var(--ice); }
    </style>
</head>
<body>

    <canvas id="bg-canvas"></canvas>
    <div id="global-announcement"></div>

    <div id="sell-modal">
        <div class="auth-card" style="border: 1px solid #333; width: 90%; max-width: 380px; background:#0a0c10; padding:25px;">
            <h2 style="color:#fff; margin-bottom:20px; margin-top:0; font-size:18px; letter-spacing:1px;">NEW LISTING</h2>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button id="type-wts" class="type-btn active-wts" onclick="setListingType('WTS')">SELL (WTS)</button>
                <button id="type-wtb" class="type-btn" onclick="setListingType('WTB')">BUY (WTB)</button>
            </div>
            <label class="field-label" style="color:#888; margin-top:0;">PRODUCT</label>
            <input type="text" id="sell-title" placeholder="e.g. Rolex Submariner" maxlength="40" style="background:#161b22; border:1px solid #333; color:white; font-weight:bold;">
            <label class="field-label" style="color:#888;">PRICE</label>
            <input type="text" id="sell-price" placeholder="e.g. 15.000â‚¬" maxlength="20" style="background:#161b22; border:1px solid #333; color:var(--sys-yellow); font-weight:bold;">
            <label class="field-label" style="color:#888;">DESCRIPTION (OPTIONAL)</label>
            <textarea id="sell-desc" placeholder="Condition, Location..." style="width:100%; background:#161b22; border:1px solid #333; color:#aaa; border-radius:10px; padding:12px; font-family:'Inter'; height:100px; resize:none; outline:none; box-sizing: border-box; font-size:14px; line-height:1.4;"></textarea>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="submitListing()" style="flex:2; padding:14px; background:white; border:none; border-radius:10px; font-weight:900; cursor:pointer; color:#000;">POST NOW</button>
                <button onclick="closeSellModal()" style="flex:1; background:transparent; border:1px solid #333; color:#666; border-radius:10px; cursor:pointer; font-weight:bold;">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="profile-overlay" onclick="closeProfile()">
        <div class="profile-card" onclick="event.stopPropagation()">
            <div id="p-avatar-container" onclick="triggerUpload()" style="text-align:center;">
                <img id="p-avatar-display" src="" class="profile-pic-large" alt="Profile" style="display:none;">
                <span id="p-avatar-icon" class="material-icons" style="font-size: 80px; color: var(--ice); cursor:pointer; margin-bottom:10px;">account_circle</span>
            </div>
            <input type="file" id="pfp-upload" accept="image/*" hidden onchange="handlePfpSelect(this)">

            <h2 id="p-name" style="margin:0; color:var(--ice);">Name</h2>
            <div id="p-custom-status" style="font-size:12px; color:var(--sys-green); margin-bottom:10px; min-height:15px;">Status...</div>
            <div id="p-rank-container" style="font-size:11px; text-align:left; margin-bottom:5px;">
                <span id="p-level-label">Level</span> <span id="p-level">1</span>
            </div>
            <div class="xp-bar"><div id="p-xp-fill" class="xp-fill"></div></div>
            <div id="p-bio" class="profile-bio">Bio loading...</div>
            <div class="profile-stats">
                <div><b id="p-msgs">0</b><br>Messages</div>
                <div><b id="p-joined">?</b><br>Joined</div>
            </div>
            <div id="profile-actions" style="margin-top:20px; display:flex; gap:10px;">
                <button id="p-dm-btn" style="flex:1; padding:10px; border-radius:10px; border:none; background:var(--ice); font-weight:bold;">Message</button>
                <button onclick="closeProfile()" style="flex:1; padding:10px; border-radius:10px; border:1px solid #444; background:transparent; color:#fff;">Close</button>
            </div>
        </div>
    </div>

    <div id="ban-overlay">
        <span class="material-icons" style="font-size: 64px;">gavel</span>
        <h1>YOU ARE BANNED</h1>
        <p>Your access has been revoked by an admin.</p>
        <div id="ban-timer">Calculating...</div>
    </div>
    
    <div id="unban-overlay">
        <span class="material-icons" style="font-size: 64px;">check_circle</span>
        <h1>UNBANNED</h1>
        <p>Welcome back to Sub-Zero.</p>
    </div>

    <div id="auth-screen">
        <div class="auth-card">
            <h2 id="auth-title" style="color:var(--ice); margin-bottom: 10px;">LOGIN</h2>
            <div class="online-indicator">
                <div class="dot"></div>
                <span id="auth-online-counter">0/150 Users Online</span>
            </div>
            <small id="reg-info" class="info-txt hidden">Min. 5 chars â€¢ No special characters</small>
            <input type="text" id="l-user" placeholder="Username" oninput="checkNameAvailability()">
            <span id="name-status"></span>
            <input type="password" id="l-pass" placeholder="Password">
            <div id="confirm-box" class="hidden">
                <input type="password" id="l-pass-confirm" placeholder="Confirm Password">
            </div>
            <button id="btn-login" onclick="auth('login')" style="width:100%; padding:12px; background:var(--ice); border:none; border-radius:10px; font-weight:bold; cursor:pointer; color:#000; margin-top:10px;">LOGIN</button>
            <button id="btn-reg-ui" onclick="showRegUI()" style="width:100%; padding:12px; background:transparent; border:1px solid var(--ice); color:var(--ice); border-radius:10px; font-weight:bold; cursor:pointer; margin-top:10px;">JOIN NOW</button>
            <span id="back-to-login" class="auth-toggle-link hidden" onclick="showLoginUI()">Back to Login</span>
            <p id="auth-err"></p>
            <div id="reset-reason-display"></div>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <div class="logo" onclick="toggleTheme()">SUB-ZERO</div>
            <div class="online-indicator" style="font-size:10px; margin-bottom:0;">
                <div class="dot" style="width:6px; height:6px;"></div>
                <span id="header-online-counter">0/150</span>
            </div>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <button class="msg-icon-btn" onclick="openMessenger()">
                <span class="material-icons">forum</span>
                <div id="global-badge" class="badge">0</div>
            </button>
            <span class="material-icons header-icon" onclick="openMyProfile()">account_circle</span>
            <span class="material-icons" style="color:var(--sys-red); cursor:pointer;" onclick="logout()">logout</span>
        </div>
    </header>

    <div id="messenger-view">
        <div class="msg-header">
            <span class="material-icons" onclick="closeMessenger()" style="cursor:pointer">arrow_back</span>
            <input type="text" id="find-user-input" class="search-bar" placeholder="Name#1234">
            <span class="material-icons" onclick="sendFriendRequest()" style="color:var(--ice); cursor:pointer">person_add</span>
        </div>
        <div id="requests-area" style="padding:15px; border-bottom:1px solid #222;" class="hidden">
            <small style="color:var(--ice); font-weight:bold;">PENDING REQUESTS</small>
            <div id="requests-list"></div>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>

    <div id="room-bar">
        <div class="room-btn active" onclick="switchRoom('Main', this)">Main<div class="room-dot" id="dot-Main"></div></div>
        <div class="room-btn" onclick="switchRoom('English', this)">EnglishðŸ‡ºðŸ‡¸<div class="room-dot" id="dot-English"></div></div>
        <div class="room-btn" onclick="switchRoom('German', this)">GermanðŸ‡©ðŸ‡ª<div class="room-dot" id="dot-German"></div></div>
        <div class="room-btn" onclick="switchRoom('Buy & Sell', this)">Buy & Sell<div class="room-dot" id="dot-Buy-&-Sell"></div></div>
        <div id="active-dm-tag" class="room-btn hidden" style="color:var(--sys-green)">DM</div>
    </div>

    <div id="chat"></div>
    <div id="typing-indicator">... is typing</div>

    <div id="bottom-area">
        <div id="reply-preview" style="display:none;">
            <span>Replying to <strong id="reply-user"></strong></span>
            <span id="close-reply" onclick="cancelReply()">Ã—</span>
        </div>
        <div id="input-bar">
            <button id="open-sell-btn" onclick="openSellModal()">+</button>
            <input type="text" id="msg-in" placeholder="Write message..." autocomplete="off" oninput="sendTyping()">
            <button class="send-btn" onclick="send()">SENT</button>
        </div>
    </div>

    <div id="admin-panel">
        <button class="admin-btn" onclick="triggerGlobalAlert()"><span class="material-icons">campaign</span></button>
    </div>

    <script>
        const API = "https://subzero-hc18.onrender.com";
        const storageKey = 'sz_v_active';
        const banKey = 'sz_ip_locked';
        let session = JSON.parse(localStorage.getItem(storageKey)) || null;
        let currentRoom = "Main", isDM = false, dmTarget = null, onlineUsers = [], lastMsgCounts = {}, currentResetId = null;
        let themes = ['', 'theme-fire', 'theme-matrix', 'theme-gold'], currentThemeIdx = parseInt(localStorage.getItem('sz_theme_idx')) || 0;
        let typingTimeout;
        let replyData = null;
        let listingType = 'WTS';

        document.body.className = themes[currentThemeIdx];
        if(localStorage.getItem(banKey) === 'true') document.getElementById('ban-overlay').style.display = 'flex';

        const savedReason = localStorage.getItem('sz_reset_reason');
        if(savedReason) {
            const reasonBox = document.getElementById('reset-reason-display');
            reasonBox.innerText = "Logout Reason: " + savedReason;
            reasonBox.style.display = 'block';
            localStorage.removeItem('sz_reset_reason');
        }

        if(session) { 
            document.getElementById('auth-screen').classList.add('hidden'); 
            if(session.isAdmin) document.getElementById('admin-panel').style.display = 'block';
            startApp(); 
        }

        function request(url) {
            const s = document.createElement('script');
            s.src = url + (url.includes('?') ? '&' : '?') + "t=" + Date.now();
            document.body.appendChild(s);
            s.onload = () => s.remove();
        }

        // --- PROFILE FUNCTIONS ---
        function openMyProfile() {
            if(!session) return;
            openProfile(session.user);
        }

        function openProfile(name) { request(`${API}/get_profile?target=${encodeURIComponent(name)}&cb=renderProfile`); }
        
        function renderProfile(data) {
            if(!data.success && data.success !== undefined) return;
            const isAdmin = data.level >= 100 || data.isAdmin;
            const levelVal = document.getElementById('p-level');
            const isMe = session && (data.username === session.user);

            // BILD ANZEIGE LOGIK
            const avatarImg = document.getElementById('p-avatar-display');
            const avatarIcon = document.getElementById('p-avatar-icon');
            
            if (data.pfp && data.pfp.length > 50) {
                avatarImg.src = data.pfp;
                avatarImg.style.display = 'inline-block';
                avatarIcon.style.display = 'none';
            } else {
                avatarImg.style.display = 'none';
                avatarIcon.style.display = 'inline-block';
            }

            // Klickbar nur wenn ich es bin
            document.getElementById('p-avatar-container').onclick = isMe ? triggerUpload : null;
            
            if(isAdmin) {
                document.getElementById('p-name').innerHTML = `${data.username.split('#')[0]} <span class="material-icons" style="font-size:24px; vertical-align:middle; color:var(--sys-red);">gavel</span>`;
                document.getElementById('p-custom-status').innerHTML = `<span class="leader-text">LEADER</span>`;
                levelVal.innerText = "âˆž";
                document.getElementById('p-xp-fill').style.width = "100%";
            } else {
                document.getElementById('p-name').innerText = data.username;
                document.getElementById('p-custom-status').innerText = data.customStatus;
                levelVal.innerText = data.level;
                const xpPercent = (data.xp / data.xpNeeded) * 100;
                document.getElementById('p-xp-fill').style.width = xpPercent + "%";
            }
            
            document.getElementById('p-name').style.color = data.color;
            document.getElementById('p-bio').innerText = data.bio;
            document.getElementById('p-msgs').innerText = data.messages;
            document.getElementById('p-joined').innerText = data.joinedAt;
            
            const dmBtn = document.getElementById('p-dm-btn');
            if(isMe) {
                dmBtn.innerText = "Edit Details";
                dmBtn.onclick = () => {
                    const nBio = prompt("New Bio (max 150):", data.bio);
                    const nStatus = prompt("New Status (max 30):", data.customStatus);
                    if(nBio !== null || nStatus !== null) {
                        updateProfilePost(nBio, nStatus);
                    }
                    closeProfile();
                };
            } else { 
                dmBtn.innerText = "Message"; 
                dmBtn.onclick = () => { startDM(data.username); closeProfile(); }; 
            }
            document.getElementById('profile-overlay').style.display = 'flex';
        }

        // --- IMAGE UPLOAD LOGIC ---
        function triggerUpload() { document.getElementById('pfp-upload').click(); }

        function handlePfpSelect(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxSize = 150; 
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
                        else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                        canvas.width = width; canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        updateProfilePost(null, null, dataUrl);
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateProfilePost(bio, status, pfp) {
            if(!session) return;
            const payload = { user: session.user, pass: session.pass };
            if(bio !== null && bio !== undefined) payload.bio = bio;
            if(status !== null && status !== undefined) payload.customStatus = status;
            if(pfp) payload.pfp = pfp;

            fetch(`${API}/update_profile_post`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(data => {
                if(data.success) {
                    if(pfp) alert("Profile picture updated!");
                    openProfile(session.user);
                }
            });
        }

        function closeProfile() { document.getElementById('profile-overlay').style.display = 'none'; }

        function openSellModal() { document.getElementById('sell-modal').style.display = 'flex'; }
        function closeSellModal() { document.getElementById('sell-modal').style.display = 'none'; }
        
        function setListingType(type) {
            listingType = type;
            const btnWts = document.getElementById('type-wts');
            const btnWtb = document.getElementById('type-wtb');
            if(type === 'WTS') {
                btnWts.className = 'type-btn active-wts';
                btnWtb.className = 'type-btn';
            } else {
                btnWts.className = 'type-btn';
                btnWtb.className = 'type-btn active-wtb';
            }
        }

        function toggleTheme() {
            currentThemeIdx = (currentThemeIdx + 1) % themes.length;
            document.body.className = themes[currentThemeIdx];
            localStorage.setItem('sz_theme_idx', currentThemeIdx);
        }

        function sendTyping() {
            if(!session) return;
            request(`${API}/typing?user=${encodeURIComponent(session.user)}&room=${encodeURIComponent(isDM ? 'dm_'+dmTarget : currentRoom)}`);
        }

        function triggerGlobalAlert() {
            const msg = prompt("Global Alert Nachricht:");
            if(msg) request(`${API}/send_safe?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&text=${encodeURIComponent('/alert ' + msg)}`);
        }

        function checkNameAvailability() {
            const u = document.getElementById('l-user').value.trim();
            const statusEl = document.getElementById('name-status');
            const confirmBox = document.getElementById('confirm-box');
            if (confirmBox.classList.contains('hidden') || u.length === 0) { statusEl.innerText = ""; return; }
            request(`${API}/auth?mode=check&user=${encodeURIComponent(u)}&cb=checkCB`);
        }

        function checkCB(r) {
            const statusEl = document.getElementById('name-status');
            if(r.isBanned) { localStorage.setItem(banKey, 'true'); document.getElementById('ban-overlay').style.display = 'flex'; return; }
            if (!r.valid) { statusEl.innerText = "âœ– Too short / Invalid"; statusEl.style.color = "orange"; }
            else if (r.taken) { statusEl.innerText = "âœ– Name taken"; statusEl.style.color = "var(--sys-red)"; }
            else { statusEl.innerText = "âœ” Name available"; statusEl.style.color = "var(--sys-green)"; }
        }

        function showRegUI() {
            document.getElementById('auth-title').innerText = "SIGN UP";
            document.getElementById('confirm-box').classList.remove('hidden');
            document.getElementById('reg-info').classList.remove('hidden');
            document.getElementById('btn-login').innerText = "CREATE ACCOUNT";
            document.getElementById('btn-login').setAttribute("onclick", "auth('register')");
            document.getElementById('btn-reg-ui').classList.add('hidden');
            document.getElementById('back-to-login').classList.remove('hidden');
        }

        function showLoginUI() {
            document.getElementById('auth-title').innerText = "LOGIN";
            document.getElementById('confirm-box').classList.add('hidden');
            document.getElementById('reg-info').classList.add('hidden');
            document.getElementById('name-status').innerText = "";
            document.getElementById('btn-login').innerText = "LOGIN";
            document.getElementById('btn-login').setAttribute("onclick", "auth('login')");
            document.getElementById('btn-reg-ui').classList.remove('hidden');
            document.getElementById('back-to-login').classList.add('hidden');
        }

        function auth(mode) {
            const u = document.getElementById('l-user').value.trim(), p = document.getElementById('l-pass').value.trim(), pc = document.getElementById('l-pass-confirm').value.trim(), err = document.getElementById('auth-err');
            if(mode === 'register' && u.length < 5) { err.innerText = "Username min. 5 characters!"; return; }
            if(mode === 'register' && p !== pc) { err.innerText = "Passwords do not match!"; return; }
            err.innerText = "";
            let url = `${API}/auth?mode=${mode}&user=${encodeURIComponent(u)}&pass=${encodeURIComponent(p)}&cb=authCB`;
            if(mode === 'register') url += `&passConfirm=${encodeURIComponent(pc)}`;
            request(url);
        }

        function authCB(r) {
            if(r.isBanned) { localStorage.setItem(banKey, 'true'); document.getElementById('ban-overlay').style.display = 'flex'; return; }
            if(r.success) {
                if(r.msg && r.msg.includes('Created')) { alert(r.msg); showLoginUI(); }
                else { session = r; localStorage.setItem(storageKey, JSON.stringify(r)); location.reload(); }
            } else { document.getElementById('auth-err').innerText = r.msg; }
        }

        function openMessenger() { document.getElementById('messenger-view').style.display = 'flex'; loadSocial(); }
        function closeMessenger() { document.getElementById('messenger-view').style.display = 'none'; }
        function loadSocial() { request(`${API}/get_social?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&cb=renderMessenger`); }

        function renderMessenger(data) {
            const list = document.getElementById('chat-list'), reqList = document.getElementById('requests-list'), reqArea = document.getElementById('requests-area');
            if(data.requests.length > 0) {
                reqArea.classList.remove('hidden');
                reqList.innerHTML = data.requests.map(r => `
                    <div class="chat-item">
                        <span class="chat-name">${r.requester}</span>
                        <div class="action-btns">
                            <span class="material-icons" style="color:var(--sys-green); cursor:pointer" onclick="handleReq('${r._id}', 'accept')">check_circle</span>
                            <span class="material-icons" style="color:var(--sys-red); cursor:pointer" onclick="handleReq('${r._id}', 'decline')">cancel</span>
                        </div>
                    </div>
                `).join('');
            } else { reqArea.classList.add('hidden'); }
            let html = data.friends.map(f => {
                const name = f.requester === session.user ? f.recipient : f.requester;
                const isOnline = onlineUsers.includes(name);
                return `
                    <div class="chat-item" onclick="openProfile('${name}')">
                        <div class="status-wrap">
                            <div class="online-dot" style="background:${isOnline ? 'var(--sys-green)' : '#444'}; box-shadow:${isOnline ? '0 0 10px var(--sys-green)' : 'none'}"></div>
                        </div>
                        <div class="chat-info">
                            <span class="chat-name">${name}</span>
                            <span class="chat-last-msg">${isOnline ? 'Online now' : 'Offline'}</span>
                        </div>
                        <span class="material-icons" style="color:#333; cursor:pointer" onclick="event.stopPropagation(); blockUser('${f._id}')">block</span>
                    </div>
                `;
            }).join('');
            list.innerHTML = html;
        }

        function startDM(name) {
            isDM = true; dmTarget = name; closeMessenger();
            const tag = document.getElementById('active-dm-tag');
            tag.innerText = "DM: " + name.split('#')[0]; tag.classList.remove('hidden');
            document.querySelectorAll('.room-btn').forEach(b => b.classList.remove('active'));
            tag.classList.add('active'); loadMsgs();
        }

        function sendFriendRequest() {
            const name = document.getElementById('find-user-input').value.trim();
            if(!name) return;
            request(`${API}/friend_request?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&targetName=${encodeURIComponent(name)}`);
            document.getElementById('find-user-input').value = "";
        }

        function handleReq(id, action) { request(`${API}/handle_request?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&requestId=${id}&action=${action}`); setTimeout(loadSocial, 500); }
        function blockUser(id) { if(confirm("Block this user?")) { request(`${API}/handle_request?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&requestId=${id}&action=block`); setTimeout(loadSocial, 500); } }

        function switchRoom(name, el) {
            isDM = false; dmTarget = null; currentRoom = name;
            document.getElementById('active-dm-tag').classList.add('hidden');
            document.querySelectorAll('.room-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            const dot = document.getElementById('dot-' + name.replace(/\s+/g, '-'));
            if(dot) dot.style.display = 'none';
            
            const sellBtn = document.getElementById('open-sell-btn');
            const msgInput = document.getElementById('msg-in');
            
            if(name === 'Buy & Sell') {
                sellBtn.style.display = 'block';
                msgInput.placeholder = "Use (+) to list item...";
            } else {
                sellBtn.style.display = 'none';
                msgInput.placeholder = "Write message...";
            }
            loadMsgs();
        }

        // --- DELETE WITH INTELLIGENT CONFIRM ---
        function deleteMsg(id) { 
            // WENN ADMIN: LÃ¶schen ohne Nachfrage
            if (session.isAdmin) {
                request(`${API}/delete?id=${id}&user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}`); 
                setTimeout(loadMsgs, 300);
            } 
            // WENN USER: Nachfrage
            else {
                if(confirm("Delete this post?")) {
                    request(`${API}/delete?id=${id}&user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}`); 
                    setTimeout(loadMsgs, 300);
                }
            }
        }

        function prepareReply(user) {
            replyData = user;
            document.getElementById('reply-user').innerText = user;
            document.getElementById('reply-preview').style.display = 'block';
            document.getElementById('msg-in').focus();
        }

        function cancelReply() {
            replyData = null;
            document.getElementById('reply-preview').style.display = 'none';
        }

        function submitListing() {
            const title = document.getElementById('sell-title').value.trim();
            const price = document.getElementById('sell-price').value.trim();
            const desc = document.getElementById('sell-desc').value.trim();

            if(!title || !price) { alert("Title and Price are required!"); return; }
            const formattedMsg = `$$MARKET$$|${listingType}|${title}|${price}|${desc}`;
            const url = `${API}/send_safe?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&text=${encodeURIComponent(formattedMsg)}&room=${encodeURIComponent(currentRoom)}`;
            request(url);
            closeSellModal();
            document.getElementById('sell-title').value = "";
            document.getElementById('sell-price').value = "";
            document.getElementById('sell-desc').value = "";
            setTimeout(loadMsgs, 300);
        }

        function displayMessages(data) {
            const chat = document.getElementById('chat');
            if(!Array.isArray(data)) return;
            const isAtBottom = chat.scrollHeight - chat.scrollTop <= chat.clientHeight + 50;
            
            chat.innerHTML = data.map(m => {
                if(m.isAlert) return `<div class="admin-join-banner">ADMIN DETECTED: ${m.text}</div>`;
                
                // --- LOGIK FÃœR GELÃ–SCHTE NACHRICHTEN ---
                const isAdminDel = m.text === "$$ADMIN_DEL$$" || m.text === "DELETED_BY_ADMIN";
                const isUserDel = m.text === "$$USER_DEL$$" || m.text === "DELETED_BY_OWNER";
                const isDeleted = isAdminDel || isUserDel;

                let msgContent = m.text;
                let isCard = false;

                // 1. WENN GELÃ–SCHT -> Text anzeigen (keine Karte)
                if (isDeleted) {
                    if (isAdminDel) {
                        msgContent = "<i style='color:#ff4444'>This message was removed by an admin.</i>";
                    } else {
                        msgContent = "<i style='color:#666'>This message was deleted.</i>";
                    }
                } 
                // 2. WENN MARKTPLATZ & NICHT GELÃ–SCHT -> Karte anzeigen
                else if (m.text.includes('$$MARKET$$')) {
                    isCard = true;
                }

                if (m.isSystem) return `<div class="sys-small" style="color:${m.color || '#666'}">${m.text}</div>`;
                
                const isAdmin = session && session.isAdmin, isMe = session && (m.user === session.user || m.sender === session.user);
                const msgUser = m.user || m.sender;
                
                let displayName = msgUser;
                const isMsgAdmin = (m.color === 'var(--sys-red)' || m.color === '#ff0000' || (session && session.isAdmin && m.user === session.user)); 
                
                if (isMsgAdmin || m.isAdmin) {
                    displayName = `${msgUser.split('#')[0]} <span class="material-icons" style="font-size:12px; vertical-align:middle; color:var(--sys-red);">gavel</span>`;
                }

                const showX = !isDeleted && (isAdmin || isMe);
                const delBtn = showX ? `<span class="del-x" onclick="deleteMsg('${m._id}')">Ã—</span>` : '';
                const cardDelBtn = showX ? `<span class="card-del-btn material-icons" onclick="event.stopPropagation(); deleteMsg('${m._id}')">close</span>` : '';

                let ipDisplay = '';
                if(isAdmin && m.user !== 'SYSTEM') { ipDisplay = `<span class="ip-label">[${m.userIp || '?'}]</span>`; }

                const isMentioned = session && m.text.includes(`@${session.user}`);
                const replyUI = `<span class="material-icons reply-btn" onclick="prepareReply('${msgUser}')">reply</span>`;

                // --- KARTE RENDERN (Nur wenn nicht gelÃ¶scht!) ---
                if (isCard) {
                    const cleanContent = m.text.replace('$$MARKET$$|', '');
                    const parts = cleanContent.split('|'); 
                    const type = parts[0] || 'WTS';
                    const title = parts[1] || 'Item';
                    const price = parts[2] || '0';
                    const desc = parts[3] || '';
                    const seller = m.user || m.sender;
                    const isMeCard = session && (seller === session.user);
                    
                    const cardBorderColor = m.color || 'var(--border)';
                    const typeColor = type === 'WTS' ? 'var(--sys-green)' : 'var(--sys-red)';
                    const btnLabel = type === 'WTS' ? 'CONTACT SELLER' : 'CONTACT BUYER';

                    return `
                        <div class="product-card" style="border-left: 4px solid ${cardBorderColor};" onclick="startDM('${seller}')">
                            ${cardDelBtn}
                            <div class="card-tag" style="border: 1px solid ${typeColor}; color:${typeColor};">${type}</div>
                            <div class="seller-info">Seller: <b style="color:${m.color}">${seller}</b></div>
                            
                            <span class="field-label">PRODUCT</span>
                            <span class="card-title">${title}</span>
                            
                            <span class="field-label">PRICE</span>
                            <span class="card-price-tag" style="color:var(--sys-yellow);">${price}</span>
                            
                            <span class="field-label">DESCRIPTION</span>
                            <span class="card-desc">${desc}</span>
                            
                            ${!isMeCard ? `<button class="buy-btn">${btnLabel}</button>` : ''}
                            ${isMeCard ? '<div style="text-align:right; font-size:10px; color:#666; margin-top:5px;">YOUR LISTING</div>' : ''}
                        </div>
                    `;
                }

                // --- NORMALE NACHRICHT (ODER GELÃ–SCHT NACHRICHT) RENDERN ---
                return `
                    <div class="msg ${isMe ? 'me' : ''} ${isMentioned ? 'mentioned' : ''}" style="border-${isMe ? 'right' : 'left'}-color:${m.color || 'var(--ice)'}">
                        ${delBtn}
                        ${!isMe ? replyUI : ''}
                        <div style="font-size:9px; opacity:0.6">${m.time}</div>
                        <b style="color:${m.color}; cursor:pointer" onclick="openProfile('${msgUser}')">${displayName}:</b>${ipDisplay}<br>
                        <span>${msgContent}</span>
                    </div>
                `;
            }).join('');
            
            if(isAtBottom) chat.scrollTop = chat.scrollHeight;
        }

        function send() {
            const input = document.getElementById('msg-in');
            let txt = input.value.trim();
            if(!txt) return;

            if(replyData) {
                txt = `@${replyData} ${txt}`;
                cancelReply();
            }

            const url = isDM ? 
                `${API}/send_dm?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&target=${encodeURIComponent(dmTarget)}&text=${encodeURIComponent(txt)}` :
                `${API}/send_safe?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&text=${encodeURIComponent(txt)}&room=${encodeURIComponent(currentRoom)}`;
            
            request(url); input.value = ""; setTimeout(loadMsgs, 300);
        }

        function loadMsgs() {
            if(isDM) request(`${API}/get_dms?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&target=${encodeURIComponent(dmTarget)}&cb=displayMessages`);
            else request(`${API}/messages_jsonp?user=${encodeURIComponent(session.user)}&pass=${encodeURIComponent(session.pass)}&room=${encodeURIComponent(currentRoom)}&callback=displayMessages`);
        }

        function startApp() { 
            loadMsgs(); 
            request(`${API}/check_updates?user=${encodeURIComponent(session ? session.user : '')}&room=${currentRoom}&callback=initResetId`);
            setInterval(() => {
                if(localStorage.getItem(banKey) !== 'true') loadMsgs();
                request(`${API}/check_updates?user=${encodeURIComponent(session ? session.user : '')}&room=${currentRoom}&callback=updateBadges`);
            }, 1000); 
        }

        function initResetId(data) { if(data.resetTrigger) currentResetId = data.resetTrigger; }

        function updateBadges(data) {
            const banUI = document.getElementById('ban-overlay'), unbanUI = document.getElementById('unban-overlay'), timerEl = document.getElementById('ban-timer');
            
            if(data.onlineCount !== undefined) {
                document.getElementById('auth-online-counter').innerText = `${data.onlineCount}/150 Users Online`;
                document.getElementById('header-online-counter').innerText = `${data.onlineCount}/150`;
            }

            if (data.isBanned) {
                if (localStorage.getItem(banKey) !== 'true') { localStorage.setItem(banKey, 'true'); }
                banUI.style.display = 'flex';
                if(timerEl) timerEl.innerText = data.banTimeLeft || "PERMANENT";
                return;
            } else if (localStorage.getItem(banKey) === 'true') {
                localStorage.removeItem(banKey);
                banUI.style.display = 'none'; unbanUI.style.display = 'flex'; unbanUI.style.opacity = '1';
                setTimeout(() => { unbanUI.style.opacity = '0'; setTimeout(() => { location.reload(); }, 500); }, 3000);
                return;
            }
            if(!session) return;
            if (data.resetTrigger && currentResetId && data.resetTrigger !== currentResetId) {
                if(!session.isAdmin) { if(data.resetReason) localStorage.setItem('sz_reset_reason', data.resetReason); logout(); return; } 
                else { currentResetId = data.resetTrigger; }
            }
            const alertBox = document.getElementById('global-announcement');
            if(data.globalAlert) { alertBox.innerText = data.globalAlert; alertBox.style.display = 'block'; }
            else { alertBox.style.display = 'none'; }
            const typingEl = document.getElementById('typing-indicator');
            if(data.typingUser && data.typingUser !== session.user) {
                typingEl.innerText = `${data.typingUser} is typing...`; typingEl.style.display = 'block';
                clearTimeout(typingTimeout); typingTimeout = setTimeout(() => { typingEl.style.display = 'none'; }, 3000);
            }
            onlineUsers = data.onlineFriends || [];
            const badge = document.getElementById('global-badge');
            if(data.dmCount > 0) { badge.innerText = data.dmCount; badge.style.display = 'block'; }
            else { badge.style.display = 'none'; }
            for(let room in data.counts) {
                if(room !== currentRoom) {
                    if(lastMsgCounts[room] !== undefined && data.counts[room] > lastMsgCounts[room]) {
                        const dot = document.getElementById('dot-' + room.replace(/\s+/g, '-'));
                        if(dot) dot.style.display = 'block';
                    }
                }
                lastMsgCounts[room] = data.counts[room];
            }
        }

        function logout() { 
            if(session) { request(`${API}/logout_notify?user=${encodeURIComponent(session.user)}&room=${encodeURIComponent(currentRoom)}`); }
            setTimeout(() => { localStorage.removeItem(storageKey); location.reload(); }, 300);
        }
        document.getElementById('msg-in').onkeypress = (e) => { if(e.key === "Enter") send(); };
        if(!session) { setInterval(() => { if(localStorage.getItem(banKey) === 'true' || !session) { request(`${API}/check_updates?user=&room=Main&callback=updateBadges`); } }, 1000); }
    </script>
</body>
</html>
